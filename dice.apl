:NameSpace dice
⎕IO ← 0

_U_ ← {⍺←⊢ ⋄ ⍵⍵⍣¯1⊢⍺ ⍺⍺⍥⍵⍵ ⍵}
_O_ ← {⍺←⍵ ⋄ (⍺⍺ ⍺)⍵⍵ ⍵}

P  ← ⊣⊂⍨1,2≠/⊢

_I ← { 
    l ← ⍵∊⊂⍺
    l[(≢⌊1(-,+)⍨⍸)l] ← 1
    l≡0:⍵
    ⊃,/ ⍺⍺@{∧/¨P l} ⍵ P l
}

⍝ Doesn't handle parentheses
Parse  ← {
    r  ← (⍵~' ') (⊣P∊) '0123456789'
    
    r {w ← ⊃⍵ ⋄ ⊂,/'(1⊥?'(⊃ ⊣/w)'⍴'(⊃ ⊢/w)')'}_I⍨∘, 'O'
}

⍝ Dice.Parse '1O20 + 1'
⍝ ┌─────────┬─┬─┐
⍝ │(+/?1⍴20)│+│1│
⍝ └─────────┴─┴─┘

:EndNameSpace
