:NameSpace dice

_U_ ← {⍺←⊢ ⋄ ⍵⍵⍣¯1⊢⍺ ⍺⍺⍥⍵⍵ ⍵}
_O_ ← {⍺←⍵ ⋄ (⍺⍺ ⍺)⍵⍵ ⍵}

P  ← ⊣⊂⍨1,2≠/⊢

_I ← { 
    loc ← ⍵∊⊂⍺
    ri  ← 1@(≢↑((-,+)∘1)_U_⍸)loc
    ri≡0:⍵
    ⊃,/ ⍺⍺@{∧/¨P ri} ⍵ P ri
}

⍝ Doesn't handle parentheses
Parse  ← {
    r  ← (⍵~' ') (⊣P∊) '0123456789'
    
    r {w ← ⊃⍵ ⋄ ⊂,/'(1⊥?'(⊃ ⊣/w)'⍴'(⊃ ⊢/w)')'}_I⍨∘, 'O'
}

⍝ Dice.Parse '1O20 + 1'
⍝ ┌─────────┬─┬─┐
⍝ │(+/?1⍴20)│+│1│
⍝ └─────────┴─┴─┘

:EndNameSpace
